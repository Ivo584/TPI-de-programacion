<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil de Usuario – Colegio Ernesto Guevara</title>
  <link rel="stylesheet" href="css/style6.css"/>
</head>
<body>
  <div class="header-banner">
    <div class="logo-slot">
      <img src="img/logo.png" alt="Logo Colegio Ernesto Guevara" class="mi-imagen" />
    </div>
  </div>
  <div class="page-wrap">
    <div class="registration-form" style="max-width:500px;">
      <h2 style="margin-bottom:1rem;">Perfil de Usuario</h2>
      <div class="form-section">
        <table style="width:100%; border-collapse:separate; border-spacing:0 10px;">
          <tr>
            <td style="font-weight:600; color:#0f1724; width:40%;">Nombre:</td>
            <td id="perfil-nombre">María</td>
          </tr>
          <tr>
            <td style="font-weight:600; color:#0f1724;">Apellido:</td>
            <td id="perfil-apellido">Pérez</td>
          </tr>
          <tr>
            <td style="font-weight:600; color:#0f1724;">Correo electrónico:</td>
            <td id="perfil-email">maria@ejemplo.com</td>
          </tr>
          <tr>
            <td style="font-weight:600; color:#0f1724;">Nombre de usuario:</td>
            <td id="perfil-usuario">mariap</td>
          </tr>
          <tr>
            <td style="font-weight:600; color:#0f1724;">DNI:</td>
            <td id="perfil-dni">12345678</td>
          </tr>
        </table>
      </div>
      <div class="form-actions">
        <button type="button" onclick="location.href='estudiante.html'">Volver</button>
        <button type="button" onclick="location.href='index.html'">Salir</button>
      </div>
    </div>
  </div>

  <script>
    (async function loadPerfil() {
      try {
        // Obtener email y nombre/apellido/dni del usuario logueado (localStorage o querystring)
        let email = localStorage.getItem('usuario_email');
        let nombre = localStorage.getItem('usuario_nombre');
        let apellido = localStorage.getItem('usuario_apellido');
        let dni = localStorage.getItem('usuario_dni');
        let usuario = localStorage.getItem('usuario_username') || '';

        if (!email) {
          const params = new URLSearchParams(window.location.search);
          email = params.get('email');
        }
        // Consultar backend para obtener todos los datos actualizados
        const res = await fetch('http://localhost:3005/api/perfil?email=' + encodeURIComponent(email));
        if (!res.ok) throw new Error('Respuesta no OK');
        const data = await res.json();

        // Separar nombre y apellido si apellido está vacío o es "local"
        let nombreFinal = data.nombre || nombre || '';
        let apellidoFinal = data.apellido || apellido || '';
        if ((apellidoFinal === '' || apellidoFinal.toLowerCase() === 'local') && nombreFinal.includes(' ')) {
          const partes = nombreFinal.trim().split(' ');
          nombreFinal = partes[0];
          apellidoFinal = partes.slice(1).join(' ');
        }
        // Si username no está, usar el primer nombre (sin espacios)
        let usuarioFinal = usuario || (data.usuario && data.usuario.split(' ')[0]) || nombreFinal;

        // Mostrar el dni registrado por el estudiante (preferir localStorage)
        let dniFinal = dni || data.dni || '';

        document.getElementById('perfil-nombre').textContent = nombreFinal;
        document.getElementById('perfil-apellido').textContent = apellidoFinal;
        document.getElementById('perfil-email').textContent = data.email || email || '';
        document.getElementById('perfil-usuario').textContent = usuarioFinal;
        document.getElementById('perfil-dni').textContent = dniFinal;
      } catch (err) {
        console.warn('No se pudo obtener perfil:', err);
        // deja los valores estáticos si falla
      }
    })();
  </script>
</body>
</html>
