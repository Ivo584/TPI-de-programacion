<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Usuario – Colegio Ernesto Guevara</title>
  <link rel="stylesheet" href="css/style3.css" />

</head>
<body>
  <div class="header-banner">
    <div class="logo-slot">
      <img src="img/logo.png" alt="Logo Colegio Ernesto Guevara" class="mi-imagen" />
    </div>
    <!-- Puedes agregar navegación aquí si lo deseas -->
  </div>
  <div class="page-wrap">
    <form class="registration-form" id="registrationForm">

      <!-- Indicación de campos obligatorios -->
      <p class="form-note">
        En este formulario hay campos obligatorios <span class="required-mark">❍</span>
      </p>

      <!-- Sección Credenciales -->
      <section class="form-section">
        <h2>Credenciales</h2>

        <label for="username">
          Nombre de usuario <span class="required-mark">❍</span>
        </label>
        <input
          type="text"
          id="username"
          name="username"
          required
        />

        <label for="password">
          Contraseña <span class="required-mark">❍</span>
        </label>
        <div class="input-with-icon" style="position:relative;">
          <input
            type="password"
            id="password"
            name="password"
            required
            style="padding-right:2.6rem;"
          />
          <button type="button" class="pw-toggle-login" aria-label="Mostrar contraseña" aria-pressed="false" title="Mostrar contraseña">
             <!-- ojo (ocultar/mostrar) -->
             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
               <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"></path>
               <circle cx="12" cy="12" r="3"></circle>
             </svg>
           </button>
         </div>
        <small class="guideline">
          La contraseña debería cumplir las siguientes condiciones:
        </small>
        <ul class="pwd-criteria" aria-live="polite" aria-atomic="true">
          <li id="pwd-crit-length" class="pwd-crit fail">❌ Al menos 8 caracteres</li>
          <li id="pwd-crit-digit"  class="pwd-crit fail">❌ Al menos 1 dígito</li>
          <li id="pwd-crit-lower"  class="pwd-crit fail">❌ Al menos 1 minúscula</li>
        </ul>
      </section>

      <!-- Sección Información Personal -->
      <section class="form-section">
        <h2>Por favor, escriba algunos datos sobre usted</h2>

        <label for="email">
          Dirección de correo <span class="required-mark">❍</span>
        </label>
        <input
          type="email"
          id="email"
          name="email"
          required
        />

        <label for="emailConfirm">
          Correo (de nuevo) <span class="required-mark">❍</span>
        </label>
        <input
          type="email"
          id="emailConfirm"
          name="emailConfirm"
          required
        />

        <label for="firstName">
          Nombre <span class="required-mark">❍</span>
        </label>
        <input
          type="text"
          id="firstName"
          name="firstName"
          required
        />

        <label for="lastName">
          Apellido(s) <span class="required-mark">❍</span>
        </label>
        <input
          type="text"
          id="lastName"
          name="lastName"
          required
        />
      </section> <!-- <-- cerramos la sección que faltaba -->

      <!-- Sección Rol y Curso -->
      <section class="form-section">
        <h2>Tipo de cuenta y curso</h2>

        <label for="role">Tipo de cuenta <span class="required-mark">❍</span></label>
        <select id="role" name="role" required>
          <option value="Estudiante" selected>Estudiante</option>
          <option value="Profesor">Profesor</option>
        </select>

        <label for="curso" id="label-curso" style="margin-top:10px;">
          Curso (solo para Estudiantes) <span class="required-mark">❍</span>
        </label>
        <select id="curso" name="curso" required>
          <!-- Se generan 1°..7° con divisiones 1..4 -->
          <!-- Rellenado con JS al cargar la página -->
        </select>
      </section>

      <!-- Sección Otros Campos -->
      <section class="form-section">
        <h2>Otros campos</h2>

        <label for="dni">
          DNI <span class="required-mark">❍</span>
        </label>
        <input
          type="text"
          id="dni"
          name="dni"
          required
        />
      </section>

      <!-- Botones finales -->
      <div class="form-actions">
        <button type="submit">Crear cuenta</button>
        <button type="button" onclick="location.href='index.html'">Cancelar</button>
      </div>
    </form>
  </div>
  <script>
    // Funcionalidad: ocultar/mostrar "required-mark" cuando el campo tenga contenido
    (function() {
      const form = document.getElementById('registrationForm');
      if (!form) return;
      const pwdInput = form.querySelector('#password');
      const critLength = document.getElementById('pwd-crit-length');
      const critDigit  = document.getElementById('pwd-crit-digit');
      const critLower  = document.getElementById('pwd-crit-lower');

      function setCrit(el, ok) {
        if (!el) return;
        el.classList.toggle('ok', ok);
        el.classList.toggle('fail', !ok);
        el.textContent = (ok ? '✅ ' : '❌ ') + el.textContent.replace(/^[✅❌]\s*/, '');
      }

      // Comprueba la contraseña y devuelve estado
      function checkPwdValidity(pwd) {
        const length = pwd.length >= 8;
        const digit  = /\d/.test(pwd);
        const lower  = /[a-z]/.test(pwd);
        return { length, digit, lower, valid: length && digit && lower };
      }
      // Exponer para que onsubmit pueda reutilizarla
      window.checkPwdValidity = checkPwdValidity;

      function updatePwdIndicators(pwd) {
        const st = checkPwdValidity(pwd);
        setCrit(critLength, st.length);
        setCrit(critDigit, st.digit);
        setCrit(critLower, st.lower);
      }

      function updateMarkForInput(input) {
        const id = input.id;
        if (!id) return;
        const lbl = form.querySelector(`label[for="${id}"]`);
        const mark = lbl?.querySelector('.required-mark');
        if (!mark) return;
        if (input.type === 'checkbox' || input.type === 'radio') {
          mark.style.display = input.checked ? 'none' : '';
        } else {
          mark.style.display = input.value.trim() ? 'none' : '';
        }
      }

      // Inicializar y añadir listeners a todos los inputs del formulario
      const inputs = Array.from(form.querySelectorAll('input, textarea, select'));
      inputs.forEach(inp => {
        // primera evaluación
        updateMarkForInput(inp);
        // eventos
        inp.addEventListener('input', () => updateMarkForInput(inp));
        inp.addEventListener('change', () => updateMarkForInput(inp));
        inp.addEventListener('blur', () => updateMarkForInput(inp));
      });

      // actualizar indicadores en tiempo real si existe el input
      if (pwdInput) {
        updatePwdIndicators(pwdInput.value || '');
        pwdInput.addEventListener('input', () => updatePwdIndicators(pwdInput.value));
      }

      // Toggle de visibilidad para inputs password dentro del formulario
      form.querySelectorAll('.pw-toggle-login').forEach(btn => {
         const wrapper = btn.closest('.input-with-icon');
         const input = wrapper?.querySelector('input[type="password"], input[type="text"]');
         if (!input) return;
         btn.addEventListener('click', () => {
           const show = input.type === 'password';
           input.type = show ? 'text' : 'password';
           btn.setAttribute('aria-pressed', show ? 'true' : 'false');
           // cambiar icono (simple swap entre ojo y ojo tachado)
           btn.innerHTML = show
             ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`
             : `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
         });
       });
    })();

    document.getElementById('registrationForm').onsubmit = async function(e) {
      e.preventDefault();

      // validaciones cliente
      const pwd = this.password.value.trim();
      const email = this.email.value.trim();
      const emailConfirm = this.emailConfirm.value.trim();

      if (email !== emailConfirm) {
        alert('Los correos no coinciden.');
        return;
      }
      // contraseña: verificar con la función expuesta
      const pwdState = window.checkPwdValidity ? window.checkPwdValidity(pwd) : null;
      if (!pwdState || !pwdState.valid) {
        // asegurar indicadores actualizados y guiar al usuario
        if (window.checkPwdValidity) {
          window.checkPwdValidity(pwd); // sólo para consistencia (los indicadores ya se actualizan en input)
        }
        alert('La contraseña no cumple todos los requisitos. Revise las indicaciones debajo del campo de contraseña.');
        this.password.focus();
        return;
      }

      const data = {
        username: this.username.value.trim(),
        password: pwd,
        email,
        emailConfirm,
        firstName: this.firstName.value.trim(),
        lastName: this.lastName.value.trim(),
        dni: this.dni.value.trim(),
        role: this.role ? this.role.value : 'Estudiante',    // <-- incluir role
        curso: this.curso ? (this.curso.value || null) : null // <-- incluir curso (puede ser null)
      };

      try {
        // apunto al backend de registro (registro.js escucha en 3004)
        const res = await fetch('http://localhost:3004/api/registro', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify(data)
         });
         if (!res.ok) {
           const err = await res.json().catch(()=>({ error: 'error en servidor' }));
           alert('Error al enviar registro: ' + (err.error || res.statusText));
           return;
         }

         // Redirect: siempre volver a index.html tras registro, tanto para Profesor como Estudiante
         alert('Registro enviado. Tu cuenta está pendiente de aprobación.');
         window.location.href = 'index.html';
       } catch (err) {
         console.error(err);
         alert('No se pudo conectar con el servidor. Intente más tarde.');
       }
     };
    // --- añadido: generación de opciones de curso y lógica mostrar/ocultar ---
    (function() {
      const cursoSel = document.getElementById('curso');
      const roleSel = document.getElementById('role');
      const labelCurso = document.getElementById('label-curso');
      if (cursoSel) {
        // generar 1°..7° con divisiones 1..4 (formato ejemplo: 2°2)
        for (let grado = 1; grado <= 7; grado++) {
          for (let div = 1; div <= 4; div++) {
            const opt = document.createElement('option');
            opt.value = `${grado}°${div}`;
            opt.textContent = `${grado}°${div}`;
            cursoSel.appendChild(opt);
          }
        }
      }
      function updateCursoVisibility() {
        const isEst = roleSel?.value === 'Estudiante';
        cursoSel.required = isEst;
        labelCurso.style.display = isEst ? '' : 'none';
        cursoSel.style.display = isEst ? '' : 'none';
      }
      if (roleSel) {
        roleSel.addEventListener('change', updateCursoVisibility);
        updateCursoVisibility();
      }

      // ajustar envío: incluir role/curso en payload
      const form = document.getElementById('registrationForm');
      form.addEventListener('submit', function(e) {
        // la lógica principal ya maneja validaciones; interceptar para agregar role/curso al body
        // (la función anterior usa this para crear "data", así que no necesitamos reimplementar aquí)
      });
    })();
  </script>
</body>
</html>
